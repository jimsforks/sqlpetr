---
title: "Using DiagrammeR with Bookdown"
author: "M. Edward (Ed) Borasky"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{Using DiagrammeR with Bookdown}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction
This project consists of two repositories:

1. <https://github.com/smithjd/sql-pet> - an eBook [@Muni2018a] we are building using Bookdown [@Xie2016]
2. <https://github.com/smithjd/sqlpetr> - an R package [@Muni2018b] containing two classes of functions:
    1. Utilities for managing the subject matter of the book - Docker images and containers, and PostgreSQL databases running in the containers.
    2. Utilities for building the book.

Our workflow is:

1. Clone the repositories.
2. Install the `sqlpetr` package with `devtools::install(".", dependencies = TRUE)`. This installs the package, all the dependencies needed to work on the package, and all of the dependencies needed to build the book and run the code samples in the book.
3. Edit the book using the Bookdown tools in RStudio. If we find an operation we perform repeatedly in the edit cycle, we'll often migrate that code into a function in `sqlpetr`. This vignette documents one such function.

    We maintain the book in two forms - the Bookdown "GitBook" HTML format and as a PDF file. The HTML book is deployed to GitHub Pages at <https://smithjd.github.io/sql-pet> and the PDF is downloadable from a button at the top of the HTML book.

To create some of the graphics in the book, we use the `DiagrammeR` package. The remainder of this vignette describes how we use it.

## Making a diagram with DiagrammeR
`DiagrammeR` [@Iannone2018] is a package for creating diagrams with R code. There are essentially two ways to create a diagram:

1. Manually, by editing a text file or text string and previewing it in RStudio, (<http://rich-iannone.github.io/DiagrammeR/io.html>), or
2. Programmatically, by writing R code that creates a graph object and then rendering it with `render_graph`.

Both of these will work in an R Markdown document that's deployed to HTML. In fact, they also work in the HTML-based "GitBook" output from Bookdown. And in the first case, there's no code required except the description of the diagram in the `DOT` language (<http://rich-iannone.github.io/DiagrammeR/graphviz_and_mermaid.html>).

For the _programmatic_ workflow, `DiagrammeR` can export a graph object to image files, which `knitr` can import into both the HTML and PDF versions of a book. But there's no easy way to go from the manual text description to image files. So we built one.

## Exporting a `grVis` object to image files
When you create a diagram manually, `DiagrammeR` returns a `grViz` object. The actual diagram is coded as a Scalable Vector Graphics (SVG) text string, and the rest of the object is metadata. 

When you create a diagram programmatically, `render_graph` returns a `grViz` object, given a (computed) graph object in an internal `DiagrammeR` format. So in either case, we have an `htmlwidget` object.

Here's an example (<http://rich-iannone.github.io/DiagrammeR/graphviz_and_mermaid.html>):

```{r}
DiagrammeR::grViz("
digraph nicegraph {

  # graph, node, and edge definitions
  graph [compound = true, nodesep = .5, ranksep = .25,
         color = crimson]

  node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = true, width = 1,
        color = darkslategray]

  edge [color = grey, arrowhead = none, arrowtail = none]

  # subgraph for R information
  subgraph cluster0 {
    node [fixedsize = true, width = 3]
    '@@1-1' -> '@@1-2' -> '@@1-3' -> '@@1-4'
    '@@1-4' -> '@@1-5' -> '@@1-6' -> '@@1-7'
  }

  # subgraph for RStudio information
  subgraph cluster1 {
    node [fixedsize = true, width = 3]
    '@@2' -> '@@3'
  }

  Information             [width = 1.5]
  Information -> R
  Information -> RStudio
  R -> '@@1-1'            [lhead = cluster0]
  RStudio -> '@@2'        [lhead = cluster1]

}

[1]: paste0(names(R.Version())[1:7], ':\\n ', R.Version()[1:7])
[2]: paste0('Version 1.2.1062')
[3]: paste0('Current program mode:\\n ', rstudioapi::versionInfo()[[2]])

")
```

Since this vignette is HTML, you can see the diagram. But to make both HTML and PDF, we need image files that `knitr` can import. For that, we'll need two more packages: `DiagrammeRsvg` (@Iannone2016) and `magick` (@Ooms2018). 

First, create a directory for the images:
```{r}
dir.create("diagrams", recursive = TRUE)

```

Create an `htmlwidget` object from the graph DOT text using `DiagrammeR::grViz`
```{r}
widget <- DiagrammeR::grViz("
digraph nicegraph {

  # graph, node, and edge definitions
  graph [compound = true, nodesep = .5, ranksep = .25,
         color = crimson]

  node [fontname = Helvetica, fontcolor = darkslategray,
        shape = rectangle, fixedsize = true, width = 1,
        color = darkslategray]

  edge [color = grey, arrowhead = none, arrowtail = none]

  # subgraph for R information
  subgraph cluster0 {
    node [fixedsize = true, width = 3]
    '@@1-1' -> '@@1-2' -> '@@1-3' -> '@@1-4'
    '@@1-4' -> '@@1-5' -> '@@1-6' -> '@@1-7'
  }

  # subgraph for RStudio information
  subgraph cluster1 {
    node [fixedsize = true, width = 3]
    '@@2' -> '@@3'
  }

  Information             [width = 1.5]
  Information -> R
  Information -> RStudio
  R -> '@@1-1'            [lhead = cluster0]
  RStudio -> '@@2'        [lhead = cluster1]

}

[1]: paste0(names(R.Version())[1:7], ':\\n ', R.Version()[1:7])
[2]: paste0('Version 1.2.1062')
[3]: paste0('Current program mode:\\n ', rstudioapi::versionInfo()[[2]])

")

```

Extract the SVG code for the diagram and write it to a file:
```{r}
library(dplyr)
widget %>% 
  DiagrammeRsvg::export_svg() %>% 
  cat(file = "diagrams/example.svg")

```

If you have an SVG viewer, like `Inkscape`, you can open the file and see the diagram!

Now, create a `.png` for importing to HTML and a `.pdf` for importing into PDFs.

```{r}
magick::image_read_svg("diagrams/example.svg") %>% 
  magick::image_write(
    path = "diagrams/example.png", 
    format = "png")
magick::image_read_svg("diagrams/example.svg") %>% 
  magick::image_write(
    path = "diagrams/example.pdf", format = "pdf")

```

## Including the image in the book
That was the hard part - it's downhill from here. A single `knitr` call is all we need to get the image displayed in our R Markdown either in an HTML or PDF document.

```{r}
knitr::include_graphics("diagrams/example.png", auto_pdf = TRUE)

```

How does this work? We have both `.png` and `.pdf` files for the image. `knitr` sees the `auto_pdf` option and makes the choice accordingly. If it's making an HTML file it uses the `.png` and if it's making a PDF file it uses the `.pdf`.

## So let's make this into a function!
```{r}
sp_make_image_files <- function(
  widget, 
  directory = "diagrams", 
  filename = "example") {
  dir.create(directory, recursive = TRUE)
  svg_name <- paste(
    directory, paste(filename, "svg", sep = "."), sep = "/")
  png_name <- paste(
    directory, paste(filename, "png", sep = "."), sep = "/")
  pdf_name <- paste(
    directory, paste(filename, "pdf", sep = "."), sep = "/")
  widget %>%  DiagrammeRsvg::export_svg() %>% 
    cat(file = svg_name)
  magick::image_read_svg(svg_name) %>% 
    magick::image_write(path = png_name, format = "png")
  magick::image_read_svg(svg_name) %>% 
    magick::image_write(path = pdf_name, format = "pdf")
  
  # return the PNG file name; it's an argument to `knitr::include_graphics`
  return(png_name)
}
```

Test it!
```{r}
file_to_include <- sp_make_image_files(
  widget, "test_diagrams", "test_file"
)
```

```{r}
knitr::include_graphics(path = file_to_include, auto_pdf = TRUE)

```

## References
